（中略：ここに前述の完全版コードを貼り直す必要があります）